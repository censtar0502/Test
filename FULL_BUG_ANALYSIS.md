# –ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó –ë–ê–ì–û–í –ò –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–• –ü–†–û–ë–õ–ï–ú

## üîç –ö–†–ò–¢–ï–†–ò–ò –ê–ù–ê–õ–ò–ó–ê
1. **–ó–∞–≤–∏—Å–∞–Ω–∏—è** - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ main loop
2. **Race conditions** - –≥–æ–Ω–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è–º–∏ –∏ main
3. **–ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –±—É—Ñ–µ—Ä–æ–≤** - buffer overflows
4. **–£—Ç–µ—á–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤** - memory/resource leaks
5. **–õ–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏** - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
6. **–¢–∞–π–º–∞—É—Ç—ã** - –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—â–∏—Ç—ã –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–π
7. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è** - –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ/–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ë–ê–ì–ò (–≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

### BUG #1: Race Condition –≤ UART RX –º–µ–∂–¥—É –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ–º –∏ main loop
**–§–∞–π–ª:** `dispenser.c`, —Å—Ç—Ä–æ–∫–∏ 16-17, 475-500, 151-427  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø

#### –ü—Ä–æ–±–ª–µ–º–∞:
```c
// –í –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–∏ (ISR):
static volatile uint16_t rx_len = 0;
static volatile uint8_t rx_ready = 0;

void HAL_UARTEx_RxEventCallback(...) {
    memcpy(rx_frame_buf, rx_dma_buf, Size);  // ‚ùå –ù–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏!
    rx_len = Size;
    rx_ready = 1;
}

// –í main loop:
void Dispenser_Update(void) {
    if (rx_ready) {
        Gas_ParseFrame(rx_frame_buf, rx_len, &frame);  // ‚ùå –ú–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å—Å—è –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏!
        // ...
        rx_ready = 0;
        HAL_UARTEx_ReceiveToIdle_DMA(...);
    }
}
```

#### –°—Ü–µ–Ω–∞—Ä–∏–π –±–∞–≥–∞:
1. Main –Ω–∞—á–∏–Ω–∞–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å `rx_frame_buf`
2. **–í —Å–µ—Ä–µ–¥–∏–Ω–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏** –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–æ–≤—ã–π UART RX callback
3. ISR **–ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç** `rx_frame_buf` –ø–æ–≤–µ—Ä—Ö –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ main –µ—â—ë —á–∏—Ç–∞–µ—Ç
4. –†–µ–∑—É–ª—å—Ç–∞—Ç: –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥, –∑–∞–≤–∏—Å–∞–Ω–∏–µ –º–∞—à–∏–Ω—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π

#### –†–µ—à–µ–Ω–∏–µ:
```c
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å double buffering –∏–ª–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é —Å–µ–∫—Ü–∏—é
void Dispenser_Update(void) {
    if (rx_ready) {
        __disable_irq();  // –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è
        uint8_t local_buf[64];
        uint16_t local_len = rx_len;
        memcpy(local_buf, rx_frame_buf, local_len);
        rx_ready = 0;
        __enable_irq();  // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
        
        GasFrame_t frame;
        Gas_ParseFrame(local_buf, local_len, &frame);
        // ...
    }
}
```

---

### BUG #2: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—â–∏—Ç—ã –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è `input_buf`
**–§–∞–π–ª:** `ui_manager.c`, —Å—Ç—Ä–æ–∫–∏ 249-253, 267-271, 291-295  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø

#### –ü—Ä–æ–±–ª–µ–º–∞:
```c
static char input_buf[16];
static uint8_t input_pos = 0;

if (key >= '0' && key <= '9') {
    if (input_pos < 10) {  // ‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ 10, –Ω–æ –±—É—Ñ–µ—Ä = 16!
        input_buf[input_pos++] = key;
        input_buf[input_pos] = '\0';  // ‚ùå –ú–æ–∂–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å –∑–∞ –ø—Ä–µ–¥–µ–ª—ã!
    }
}
```

#### –°—Ü–µ–Ω–∞—Ä–∏–π –±–∞–≥–∞:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç 10 —Ü–∏—Ñ—Ä
2. `input_pos` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è 10
3. –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–æ–∫–∞: `input_buf[10] = '\0'` ‚úÖ OK
4. –ù–û –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–º—ë—Ç –µ—â—ë –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É –ø–µ—Ä–µ–¥ –≤–≤–æ–¥–æ–º –¥—Ä—É–≥–æ–π –∫–æ–º–∞–Ω–¥—ã:
   - `input_pos = 10`, –ø—Ä–æ–≤–µ—Ä–∫–∞ `< 10` fails ‚úÖ
   - –ù–û `input_buf[input_pos] = '\0'` –≤—Å—ë —Ä–∞–≤–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è!
   - –≠—Ç–æ –ø–∏—à–µ—Ç `\0` –Ω–∞ –ø–æ–∑–∏—Ü–∏—é 10 **–∫–∞–∂–¥—ã–π —Ä–∞–∑** –ø—Ä–∏ –≤–≤–æ–¥–µ

#### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:
```c
if (input_pos < 10) {
    input_buf[input_pos++] = key;
    input_buf[input_pos] = '\0';  // –ï—Å–ª–∏ input_pos –±—ã–ª 9, —Ç–µ–ø–µ—Ä—å 10, –ø–∏—à–µ–º –≤ [10] ‚úÖ
}
```
–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ —ç—Ç–æ OK –¥–ª—è –±—É—Ñ–µ—Ä–∞ —Ä–∞–∑–º–µ—Ä–æ–º 16, –Ω–æ:
- –ú–∞–≥–∏—á–µ—Å–∫–æ–µ —á–∏—Å–ª–æ "10" –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–∞–∑–º–µ—Ä—É –±—É—Ñ–µ—Ä–∞
- –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ –∏–∑–º–µ–Ω–∏—Ç—Å—è, –ª–µ–≥–∫–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å

#### –†–µ—à–µ–Ω–∏–µ:
```c
#define INPUT_BUF_SIZE 16
static char input_buf[INPUT_BUF_SIZE];

if (key >= '0' && key <= '9') {
    if (input_pos < INPUT_BUF_SIZE - 1) {  // –û—Å—Ç–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ –¥–ª—è '\0'
        input_buf[input_pos++] = key;
        input_buf[input_pos] = '\0';
    }
}
```

---

### BUG #3: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã N –ø—Ä–∏ DS_END
**–§–∞–π–ª:** `ui_manager.c`, —Å—Ç—Ä–æ–∫–∏ 341-350  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

#### –ü—Ä–æ–±–ª–µ–º–∞:
```c
case UI_STATE_FUELLING:
    else if (g_dispenser.status == DS_END) {
        if (!transaction_closed) {
            UsbLog_Printf("Transaction END detected, closing...\r\n");
            Dispenser_CloseTransaction();  // –û—Ç–ø—Ä–∞–≤–∫–∞ N
            transaction_closed = 1;
            transaction_end_tick = HAL_GetTick();
        }
        ui_state = UI_STATE_TRANSACTION_RESULT;
        break;
    }
```

#### –°—Ü–µ–Ω–∞—Ä–∏–π –ø—Ä–æ–±–ª–µ–º—ã:
1. –ü–æ–ª—É—á–µ–Ω DS_END ‚Üí –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ N ‚úÖ
2. UI –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ `UI_STATE_TRANSACTION_RESULT`
3. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç F (Repeat):
   ```c
   if (key == 'F') {
       ui_state = prev_transaction_mode;  // –í–µ—Ä–Ω—É–ª–∏—Å—å –≤ INPUT_VOLUME
       transaction_closed = 0;  // ‚ùå –°–ë–†–û–° –§–õ–ê–ì–ê!
   }
   ```
4. –ï—Å–ª–∏ –¥–∏—Å–ø–µ–Ω—Å–µ—Ä –≤—Å—ë –µ—â—ë –≤ DS_END (–∏–ª–∏ —Å–Ω–æ–≤–∞ –ø–µ—Ä–µ—à—ë–ª), N –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ!

#### –†–µ—à–µ–Ω–∏–µ:
–°–±—Ä–∞—Å—ã–≤–∞—Ç—å `transaction_closed` —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ **–ù–û–í–û–ô** —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ K –≤ INPUT_VOLUME/AMOUNT).

---

### BUG #4: –ü–æ—Ç–µ—Ä—è rx_ready –µ—Å–ª–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç –¥–∞–Ω–Ω—ã–µ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
**–§–∞–π–ª:** `dispenser.c`, —Å—Ç—Ä–æ–∫–∏ 185-220, 396-417  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

#### –ü—Ä–æ–±–ª–µ–º–∞:
```c
// –í WAIT_STATUS:
if (rx_ready) {
    // ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ ...
    rx_ready = 0;
    HAL_UARTEx_ReceiveToIdle_DMA(...);
}

// –í –∫–æ–Ω—Ü–µ Dispenser_Update():
if (rx_ready) {  // ‚ùå –ï—â—ë —Ä–∞–∑ –ø—Ä–æ–≤–µ—Ä—è–µ–º!
    // ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ C –∫–æ–º–∞–Ω–¥—ã ...
    rx_ready = 0;
    HAL_UARTEx_ReceiveToIdle_DMA(...);
}
```

#### –°—Ü–µ–Ω–∞—Ä–∏–π:
1. –í —Å–æ—Å—Ç–æ—è–Ω–∏–∏ WAIT_STATUS –ø–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ (S –∫–æ–º–∞–Ω–¥–∞)
2. `rx_ready = 0` –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
3. **–í —ç—Ç–æ –∂–µ –≤—Ä–µ–º—è** –ø—Ä–∏—à–ª–∞ C –∫–æ–º–∞–Ω–¥–∞ (—Ç–æ—Ç–∞–ª–∞–π–∑–µ—Ä)
4. ISR —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `rx_ready = 1`
5. –ö–æ–¥ –≤ –∫–æ–Ω—Ü–µ `Dispenser_Update()` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç C –∫–æ–º–∞–Ω–¥—É ‚úÖ
6. –ù–û –µ—Å–ª–∏ **—Ç—Ä–µ—Ç—å—è** –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–∏—à–ª–∞ –º–µ–∂–¥—É WAIT_STATUS –∏ –∫–æ–Ω–µ—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π:
   - –ü–µ—Ä–≤–∞—è –∫–æ–º–∞–Ω–¥–∞: –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –≤ state machine
   - –í—Ç–æ—Ä–∞—è –∫–æ–º–∞–Ω–¥–∞: `rx_ready` –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω, –¥–∞–Ω–Ω—ã–µ –ø–æ—Ç–µ—Ä—è–Ω—ã!

#### –†–µ—à–µ–Ω–∏–µ:
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å FIFO –æ—á–µ—Ä–µ–¥—å –¥–ª—è RX –¥–∞–Ω–Ω—ã—Ö –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ –±—É—Ñ–µ—Ä–∞.

---

## üü° –ë–ê–ì–ò –°–†–ï–î–ù–ï–ô –°–ï–†–¨–ï–ó–ù–û–°–¢–ò

### BUG #5: –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ HAL_GetTick() —á–µ—Ä–µ–∑ 49 –¥–Ω–µ–π
**–§–∞–π–ª:** –í—Å–µ —Ñ–∞–π–ª—ã, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ `HAL_GetTick()`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø (–Ω–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)

#### –ü—Ä–æ–±–ª–µ–º–∞:
```c
uint32_t now = HAL_GetTick();
if (now - last_update_tick > 2000) {
    // Timeout
}
```

`HAL_GetTick()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `uint32_t` –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö:
- –ú–∞–∫—Å–∏–º—É–º: 4,294,967,295 –º—Å = ~49.7 –¥–Ω–µ–π
- –ü–æ—Å–ª–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è: —Å—á—ë—Ç—á–∏–∫ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ 0

#### –°—Ü–µ–Ω–∞—Ä–∏–π –±–∞–≥–∞:
1. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç 49 –¥–Ω–µ–π: `HAL_GetTick() = 0xFFFFFFFE` (–ø–æ—á—Ç–∏ –º–∞–∫—Å–∏–º—É–º)
2. `last_update_tick = 0xFFFFFFFE`
3. –ß–µ—Ä–µ–∑ 3 –º—Å: `HAL_GetTick() = 0x00000001` (–ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ!)
4. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ: `0x00000001 - 0xFFFFFFFE = 0x00000003` ‚úÖ (–±–ª–∞–≥–æ–¥–∞—Ä—è unsigned wrap-around)

**–ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ!** –ë–ª–∞–≥–æ–¥–∞—Ä—è unsigned arithmetic –≤ C.

–ù–û –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º–∞ –≤ `keyboard.c`:
```c
if ((now - last_scan_time) >= 50 || (now < last_scan_time)) {
    // –í—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–±—ã—Ç–æ—á–Ω–∞ –∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞!
}
```

–£—Å–ª–æ–≤–∏–µ `now < last_scan_time` **–Ω–∏–∫–æ–≥–¥–∞** –Ω–µ —Å–ª—É—á–∏—Ç—Å—è –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π unsigned –∞—Ä–∏—Ñ–º–µ—Ç–∏–∫–µ.

#### –†–µ—à–µ–Ω–∏–µ:
```c
if ((now - last_scan_time) >= 50) {  // –£–±—Ä–∞—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
    last_scan_time = now;
    // ...
}
```

---

### BUG #6: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ EEPROM
**–§–∞–π–ª:** `ui_manager.c`, —Å—Ç—Ä–æ–∫–∏ 33-36  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

#### –ü—Ä–æ–±–ª–µ–º–∞:
```c
global_price = EEPROM_LoadPrice();
if (global_price == 0 || global_price > 999999) {
    global_price = 1100;
}
```

#### –ü—Ä–æ–±–ª–µ–º—ã:
1. –ß—Ç–æ –µ—Å–ª–∏ EEPROM –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ –∏ –≤–µ—Ä–Ω—É–ª–∞ `0xFFFFFFFF`?
2. –ß—Ç–æ –µ—Å–ª–∏ –≤–µ—Ä–Ω—É–ª–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–µ—Å–ª–∏ –±—ã–ª–∞ –æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è)?
3. –ù–µ—Ç CRC/checksum –ø—Ä–æ–≤–µ—Ä–∫–∏

#### –†–µ—à–µ–Ω–∏–µ:
```c
global_price = EEPROM_LoadPrice();
// –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
if (global_price < 100 || global_price > 999999) {
    UsbLog_Printf("Invalid price from EEPROM: %u, using default\r\n", global_price);
    global_price = 1100;
    EEPROM_SavePrice(global_price);  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
}
```

---

### BUG #7: –ó–∞–≤–∏—Å–∞–Ω–∏–µ –≤ STATE_ERROR –Ω–∞ 2 —Å–µ–∫—É–Ω–¥—ã –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–∏—Å—Ç–µ–º—É
**–§–∞–π–ª:** `dispenser.c`, —Å—Ç—Ä–æ–∫–∏ 377-385  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

#### –ü—Ä–æ–±–ª–µ–º–∞:
```c
case STATE_ERROR:
    UsbLog_Printf("[ERROR] Communication error, resetting\r\n");
    g_dispenser.is_connected = 0;
    if (IsStateTimeout(2000)) {  // ‚ùå 2 —Å–µ–∫—É–Ω–¥—ã NOP!
        ChangeState(STATE_IDLE);
    }
    break;
```

–í–æ –≤—Ä–µ–º—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –≤ `STATE_ERROR` –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —Å–µ–∫—É–Ω–¥:
- –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –¥–∏—Å–ø–µ–Ω—Å–µ—Ä–∞
- –°–∏—Å—Ç–µ–º–∞ "–º—ë—Ä—Ç–≤–∞" –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- UI –º–æ–∂–µ—Ç –∑–∞—Å—Ç—Ä—è—Ç—å, –µ—Å–ª–∏ –º–∞—à–∏–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

#### –†–µ—à–µ–Ω–∏–µ:
–£–º–µ–Ω—å—à–∏—Ç—å —Ç–∞–π–º–∞—É—Ç –¥–æ 500 –º—Å –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å RX –¥–∞–Ω–Ω—ã–µ –≤ ERROR —Å–æ—Å—Ç–æ—è–Ω–∏–∏.

---

## üü¢ –ë–ê–ì–ò –ù–ò–ó–ö–û–ô –°–ï–†–¨–ï–ó–ù–û–°–¢–ò

### BUG #8: –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —á–∞—Å—Ç–æ—Ç—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥
**–§–∞–π–ª:** `dispenser.c`, –≤—Å–µ `SendFrame()` –≤—ã–∑–æ–≤—ã  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü¢ –ù–ò–ó–ö–ê–Ø

#### –ü—Ä–æ–±–ª–µ–º–∞:
–ü—Ä–∏ –±—ã—Å—Ç—Ä—ã—Ö retry –Ω–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç "—Å–ø–∞–º–∞" –∫–æ–º–∞–Ω–¥:
```c
case STATE_SEND_STATUS:
    SendFrame('S', "");  // –ú–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ
    ChangeState(STATE_WAIT_STATUS);
    break;
```

–ï—Å–ª–∏ —Ç–∞–π–º–∞—É—Ç—ã –∫–æ—Ä–æ—Ç–∫–∏–µ –∏ retry –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –±—ã—Å—Ç—Ä–æ, –º–æ–∂–Ω–æ "–∑–∞—Å–ø–∞–º–∏—Ç—å" UART.

#### –†–µ—à–µ–Ω–∏–µ:
–î–æ–±–∞–≤–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10 –º—Å).

---

### BUG #9: –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –º–æ–∂–µ—Ç –ø–æ–∫–∞–∑–∞—Ç—å –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å
**–§–∞–π–ª:** `ui_manager.c`, —Å—Ç—Ä–æ–∫–∏ 155-163  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü¢ –ù–ò–ó–ö–ê–Ø (–∑–∞—â–∏—â–µ–Ω–æ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–æ–º)

#### –ü—Ä–æ–±–ª–µ–º–∞:
```c
if (prev_transaction_mode == UI_STATE_INPUT_VOLUME && target_volume_cl > 0) {
    progress_percent = (g_dispenser.volume_cl * 100) / target_volume_cl;  // ‚úÖ –ó–∞—â–∏—Ç–∞ –µ—Å—Ç—å
}
```

–ó–∞—â–∏—Ç–∞ **–µ—Å—Ç—å** (`target_volume_cl > 0`), –Ω–æ:
- –ß—Ç–æ –µ—Å–ª–∏ `target_volume_cl` —Å—Ç–∞–Ω–µ—Ç 0 –∏–∑-–∑–∞ –±–∞–≥–æ–≤ –ø–∞–º—è—Ç–∏?
- –õ—É—á—à–µ –¥–æ–±–∞–≤–∏—Ç—å assert –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É

---

### BUG #10: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—á–∏—Å—Ç–∫–∏ —Ñ–ª–∞–≥–∞ t_command_sent –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–≤—è–∑–∏
**–§–∞–π–ª:** `dispenser.c`, —Å—Ç—Ä–æ–∫–∏ 29-30, 377-385  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü¢ –ù–ò–ó–ö–ê–Ø

#### –ü—Ä–æ–±–ª–µ–º–∞:
–ï—Å–ª–∏ —Å–≤—è–∑—å —Å –¥–∏—Å–ø–µ–Ω—Å–µ—Ä–æ–º —Ç–µ—Ä—è–µ—Ç—Å—è –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
1. `t_command_sent = 1`
2. –°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ `STATE_ERROR`
3. –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –≤–æ–∑–≤—Ä–∞—Ç –≤ `STATE_IDLE`
4. **–§–ª–∞–≥ –Ω–µ —Å–±—Ä–æ—à–µ–Ω!**
5. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∫–æ–º–∞–Ω–¥–∞ T –º–æ–∂–µ—Ç –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è

#### –†–µ—à–µ–Ω–∏–µ:
```c
case STATE_ERROR:
    t_command_sent = 0;  // –°–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥ –ø—Ä–∏ –æ—à–∏–±–∫–µ
    g_dispenser.is_connected = 0;
    if (IsStateTimeout(2000)) {
        ChangeState(STATE_IDLE);
    }
    break;
```

---

## ‚ö†Ô∏è –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ (—Ç—Ä–µ–±—É—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏)

### ISSUE #1: –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–Ω–æ–ø–æ–∫
**–§–∞–π–ª:** `keyboard.c`, —Å—Ç—Ä–æ–∫–∏ 38-57  
**–¢–∏–ø:** –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

#### –û–ø–∏—Å–∞–Ω–∏–µ:
```c
char Keyboard_Scan(void) {
    for (uint8_t r = 0; r < KEY_ROWS; r++) {
        HAL_GPIO_WritePin(row_ports[r], row_pins[r], GPIO_PIN_RESET);
        
        for (uint8_t c = 0; c < KEY_COLS; c++) {
            if (HAL_GPIO_ReadPin(col_ports[c], col_pins[c]) == GPIO_PIN_RESET) {
                HAL_GPIO_WritePin(row_ports[r], row_pins[r], GPIO_PIN_SET);
                return key_map[r][c];  // ‚ùå –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ü–ï–†–í–£–Æ –Ω–∞–π–¥–µ–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
            }
        }
        HAL_GPIO_WritePin(row_ports[r], row_pins[r], GPIO_PIN_SET);
    }
    return 0;
}
```

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–º—ë—Ç –¥–≤–µ –∫–Ω–æ–ø–∫–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –≤–µ—Ä–Ω—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–∞—è.
–≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å OK (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π), –Ω–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –ø—É—Ç–∞–Ω–∏—Ü—É.

---

### ISSUE #2: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ watchdog timer
**–§–∞–π–ª:** –í–µ—Å—å –ø—Ä–æ–µ–∫—Ç  
**–¢–∏–ø:** –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

–ï—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ –∑–∞–≤–∏—Å–Ω–µ—Ç –≤ –∫–∞–∫–æ–º-—Ç–æ –º–µ—Å—Ç–µ:
- Main loop –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è
- –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–Ω–µ—Ç "–º—ë—Ä—Ç–≤–æ–π"
- **–ù–µ—Ç –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞**

#### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:
–í–∫–ª—é—á–∏—Ç—å IWDG (Independent Watchdog) –∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å –µ–≥–æ –≤ main loop.

---

### ISSUE #3: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ UART –ø–µ—Ä–µ–¥–∞—á–∏
**–§–∞–π–ª:** `dispenser.c`, —Å—Ç—Ä–æ–∫–∞ 63  
**–¢–∏–ø:** –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

```c
HAL_UART_Transmit(&huart2, tx_buf, len, 100);  // ‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è!
```

–ï—Å–ª–∏ UART –∑–∞–Ω—è—Ç –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –∫–æ–º–∞–Ω–¥–∞ –Ω–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞, –Ω–æ —Å–∏—Å—Ç–µ–º–∞ —ç—Ç–æ–≥–æ –Ω–µ —É–∑–Ω–∞–µ—Ç.

#### –†–µ—à–µ–Ω–∏–µ:
```c
HAL_StatusTypeDef status = HAL_UART_Transmit(&huart2, tx_buf, len, 100);
if (status != HAL_OK) {
    UsbLog_Printf("UART TX error: %d\r\n", status);
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
}
```

---

### ISSUE #4: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ
**–§–∞–π–ª:** `dispenser.c`, —Å—Ç—Ä–æ–∫–∏ 246-254, 290-297, 330-345  
**–¢–∏–ø:** –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

#### –ü—Ä–æ–±–ª–µ–º–∞:
```c
if (frame.data_len >= 10) {
    char volume_str[7] = {0};
    memcpy(volume_str, &frame.data[2], 6);  // ‚ùå –ß—Ç–æ –µ—Å–ª–∏ data_len = 10, –Ω–æ –¥–∞–Ω–Ω—ã—Ö –º–µ–Ω—å—à–µ?
    g_dispenser.volume_cl = (uint32_t)atol(volume_str);
}
```

`data_len >= 10` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç **–º–∏–Ω–∏–º–∞–ª—å–Ω—É—é** –¥–ª–∏–Ω—É, –Ω–æ:
- –ß—Ç–æ –µ—Å–ª–∏ `frame.data` —Å–æ–¥–µ—Ä–∂–∏—Ç –º—É—Å–æ—Ä –ø–æ—Å–ª–µ –ø–æ–∑–∏—Ü–∏–∏ 10?
- –ß—Ç–æ –µ—Å–ª–∏ `data_len` = 10, –Ω–æ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä–æ—á–µ –∏–∑-–∑–∞ –±–∞–≥–∞ –≤ `Gas_ParseFrame()`?

#### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:
–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–∞–∑–º–µ—Ä–∞ –±—É—Ñ–µ—Ä–∞ `frame.data` –ø–µ—Ä–µ–¥ `memcpy`.

---

## üìã –°–í–û–î–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê –ë–ê–ì–û–í

| # | –°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å | –§–∞–π–ª | –°—Ç—Ä–æ–∫–∏ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|---|------------|------|--------|----------|-----------|
| 1 | üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø | dispenser.c | 16-17, 475-500 | Race condition –≤ UART RX | 1 |
| 2 | üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø | ui_manager.c | 249-295 | –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ input_buf | 2 |
| 3 | üü° –°–†–ï–î–ù–Ø–Ø | ui_manager.c | 341-350 | –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ N | 3 |
| 4 | üü° –°–†–ï–î–ù–Ø–Ø | dispenser.c | 185-417 | –ü–æ—Ç–µ—Ä—è rx_ready | 4 |
| 5 | üü° –°–†–ï–î–ù–Ø–Ø | keyboard.c | 63 | –ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è | 5 |
| 6 | üü° –°–†–ï–î–ù–Ø–Ø | ui_manager.c | 33-36 | –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ EEPROM | 6 |
| 7 | üü° –°–†–ï–î–ù–Ø–Ø | dispenser.c | 377-385 | –ó–∞–≤–∏—Å–∞–Ω–∏–µ –≤ STATE_ERROR | 7 |
| 8 | üü¢ –ù–ò–ó–ö–ê–Ø | dispenser.c | SendFrame | –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã | 8 |
| 9 | üü¢ –ù–ò–ó–ö–ê–Ø | ui_manager.c | 155-163 | –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ 0 | 9 |
| 10 | üü¢ –ù–ò–ó–ö–ê–Ø | dispenser.c | 29-30, 377-385 | –ù–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è t_command_sent | 10 |

---

## üîß –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1-2 (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –ù–ï–ú–ï–î–õ–ï–ù–ù–û):
1. **BUG #1**: –î–æ–±–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é —Å–µ–∫—Ü–∏—é –∏–ª–∏ double buffering –¥–ª—è UART RX
2. **BUG #2**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥—Ä–∞–Ω–∏—Ü –±—É—Ñ–µ—Ä–∞

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3-5 (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è):
3. **BUG #3**: –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Å–±—Ä–æ—Å `transaction_closed` –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ
4. **BUG #4**: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å FIFO –æ—á–µ—Ä–µ–¥—å –¥–ª—è RX –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
5. **BUG #5**: –£–±—Ä–∞—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –≤ keyboard.c

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 6-10 (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏):
6-10. –û—Å—Ç–∞–ª—å–Ω—ã–µ –±–∞–≥–∏ –ø–æ —Å–ø–∏—Å–∫—É

---

## üß™ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ

### –¢–µ—Å—Ç #1: –°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç UART
- –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç –¥–∏—Å–ø–µ–Ω—Å–µ—Ä–∞
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è –ª–∏ –ø–∞–∫–µ—Ç—ã
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ race conditions

### –¢–µ—Å—Ç #2: –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ HAL_GetTick()
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `HAL_GetTick()` –±–ª–∏–∑–∫–æ –∫ `0xFFFFFFFF`
- –î–æ–∂–¥–∞—Ç—å—Å—è –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ —Ç–∞–π–º–∞—É—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç

### –¢–µ—Å—Ç #3: –î–ª–∏—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞
- –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –Ω–∞ 24+ —á–∞—Å–∞
- –ü—Ä–æ–≤–æ–¥–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏ –∏ –∑–∞–≤–∏—Å–∞–Ω–∏—è

### –¢–µ—Å—Ç #4: –ì—Ä–∞–Ω–∏—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
- –í–≤–æ–¥ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã –≤ `input_buf`
- –í–≤–æ–¥ 0, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π, –æ–≥—Ä–æ–º–Ω—ã—Ö —á–∏—Å–µ–ª
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö state transitions

---

## ‚úÖ –ß–¢–û –£–ñ–ï –°–î–ï–õ–ê–ù–û –ü–†–ê–í–ò–õ–¨–ù–û

1. ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ UI_ProcessInput() –∏ UI_Draw() - –æ—Ç–ª–∏—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ!
2. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–æ–≤ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–π
3. ‚úÖ –§–ª–∞–≥ `t_command_sent` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ T
4. ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
5. ‚úÖ –ú–∞—à–∏–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º
6. ‚úÖ Retry –º–µ—Ö–∞–Ω–∏–∑–º —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–ø—ã—Ç–æ–∫
7. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–≤—è–∑–∏ (STATE_ERROR)

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ê–ù–ê–õ–ò–ó–ê

- **–§–∞–π–ª–æ–≤ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ:** 4 (dispenser.c, ui_manager.c, keyboard.c, main.c)
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~1300
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–æ–≤:** 2
- **–°—Ä–µ–¥–Ω–µ–π —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏:** 5
- **–ù–∏–∑–∫–æ–π —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏:** 3
- **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º:** 4
- **–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤:** 7

---

## üéØ –ò–¢–û–ì–û–í–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ:
1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å race condition –≤ UART** (BUG #1) - —ç—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–µ –∑–∞–≤–∏—Å–∞–Ω–∏—è
2. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –±—É—Ñ–µ—Ä–∞** (BUG #2) - –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π buffer overflow
3. **–î–æ–±–∞–≤–∏—Ç—å watchdog timer** - –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–π
4. **–ü—Ä–æ–≤–µ—Å—Ç–∏ —Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –æ—Å–æ–±–µ–Ω–Ω–æ UART –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞

### –í —Ü–µ–ª–æ–º:
–ö–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω **—Ö–æ—Ä–æ—à–æ** –∏ **–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ**! –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ø—Ä–æ–±–ª–µ–º - —ç—Ç–æ "edge cases", –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—è–≤–ª—è—é—Ç—Å—è —Ä–µ–¥–∫–æ. –û—Å–Ω–æ–≤–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è, –µ—Å—Ç—å —Ö–æ—Ä–æ—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ (–º–∞—à–∏–Ω—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π, —Ç–∞–π–º–∞—É—Ç—ã, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ).

–ì–ª–∞–≤–Ω—ã–µ —Ä–∏—Å–∫–∏:
- Race condition –≤ UART
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ watchdog
- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π
